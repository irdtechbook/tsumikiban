# とある初心者の雑魚電子工作（エレクトリッククラフト）

ESP-WROOM-02と気象庁の予報で作りたいお天気ライト

## はじめに

とある日の深夜、とあるDiscordサーバーにて同人誌に一節書いてみないかと誘われ、初心者でもいいならということでヒョコヒョコとやって参りました、せかいいと申します。初心者の視点から、表題にもある私の積み基板を使いつつ、どのようなところでつまずき、結局詰んでいくのかを記していきます。是非、箸休めにどうぞ。

## 作りたいもの
その日、傘が必要かどうかを、なんらかの形で告知してくれるデバイスを作りたいと思い、とりあえずブレッドボード上に試作しようと思いました。

### インサイト

- 技術的に難しいものでないこと
- こちらが何もしなくても近くにさえいればわかるもの
- 関係ないときに、音や見た目がうるさくないこと
- 傘が必要か分かること

### 実は、完成済みの作例がある

実はすでにネット上には一種の完成形が存在します。各種LCDやマトリックスLEDに天気や気温などを表示するものです。GAFAMのG社やA社から発売されている画面付きスマートスピーカーも、必要な機能としては条件を満たすかもしれません。

今回私が作りたいものにとても近いものをCL様という方が既に６年ほど前に作られています。(CL 2015)また、スイッチサイエンス様のECサイトには、次回入荷のステータスが未定となっていますがキットの販売ページが存在します。（SWITCH SCIENCE 2017）

しかしそれらは、真似するには技術や設備が明らかに足りなかったり、私の用途にはオーバースペックであったりするものでした。なので、動作の流れなどをパク……リスペクトしつつ進めていきました。

## 計画
以上を踏まえ、実際に試みる仕様を決めました。

まず、天気予報の取得には気象庁のAPIっぽいもの（TOYODA 2021）又はそれをLivedoor Weather Hacksと互換性のあるようにラッピングしているToroshima様（tsukumi様）作のAPI（天気予報 API（livedoor 天気互換） 2020）をGoogleAppScript（以下、GAS）からfetch()し、必要な情報のみにします。どこまでGAS側で処理し、どこからマイコン側で処理するかは作りながら検討することとしました。マイコン側のデータ取得はGASのプログラム側にdoGet()を用意しておくつもりです。

使う部材についてはESP-WROOM―02と単色LED2〜3本を中心に作ることにし、LEDの光り方で表示することにしました。常時動作では消費電力なども考えましたが、必要な時間帯以外はそもそも光っていなくてよく、IOも余裕があることからわざわざプログラムを煩雑にせずともLEDの数を増やし、常時点灯機能も無くしました。カラーLEDを導入すればCL様の作品(CL 2017)のように既成品の照明器具の中にも組み込めますし、電子ペーパーを導入すれば電源供給無しで提示し続けることもできるでしょう。多分。

インターネットアクセスのためのSSIDなどの情報はハードコーディングせず、何らかの形であとから設定する形を想定しました。

## 作業開始

まずはESP-WROOM 02をブレイクアウトボードにはんだ付けしていきます。この時、IO16のグランドを剥がしてしまいました。まさかの2極目でこの失敗、先が思いやられます。面倒臭がらずにペーストハンダやハンダ吸い取り線を買いに行けば良かったなと後悔しましたが、特別なピンではなかったので続行しました。最後に修復を試みましたが被害が拡大しそうだったため諦め、そのままです。どうにかこうにか、他のピンのハンダ付けも完了しました。

次にブレッドボードに装着します。しかし、ここでも問題が発生します。手持ちのブレッドボードではその全幅を使ってしまうのです。今までは立体的なタイプしか買わずに横着していたためブレッドボード用の平たいタイプのジャンパーワイヤは在庫がありません。ブレッドボード同士のみで合体させようにも何故か歪んでしまいます。最終的にはちょうどいい大きさの未使用のユニバーサル基板（茶色い板）に2つ固定することにしました。

その後は平和に回路を作成していき、ついにコンピュータとシリアル変換越しに接続でき、ESP恒例の文字化けしたBootメッセージもシリアルモニタから確認できました。ようやく動作確認にこぎつけました。

フラッシュモードでの起動を確認できたため、試しに`AT`と送ってみました。

## 問題発生

いままでも問題しか起きていませんが、更に問題が発生します。いいえ、些細なことを私の技量不足が問題にします。

送信したATがどこかに消えるのです。しかもよく見たらreadyの表示も出ていません。考えられる原因としては、よく聞く電流不足かと思いました。その時はただのATコマンドぐらいなら無線も使わないだろうしFTDIのシリアル変換からの電源でも問題ないだろうと考え、そこから電源をとっていたためです。

ダイソーの最安マンガン電池２本に切り替えたところうまく行きました。ちゃんとReadyが表示されたのです。また、ATと打ったらモニタ側にもATと表示されました。これは快挙だったはずでした、その後にOKでなくErrorが送られてくるということさえなければ。

電源電圧を測ったところ2.9Vまで落ちていたり、謎にリセットがかかったりしていたことが原因と推測しました。そこで、アルカリ２本の直列を２つ並列にした４本体制にもしましたが、電源電圧こそ3.1v以上に回復したもののあまり状況は変わらず…。その他にCH340系など別のシリアル変換なども用いてみましたが結局解決しませんでした。インターネットで検索してみてもそこで詰まったという投稿は見られなかったため、おそらく普通は書くまでもなく対処してしまうか、普通は発生しないということなのかなと思いました。なお、AT以外のATコマンド、AT+GMRなども試してみましたが。ことごとく無慈悲なErrorが帰ってくるのみでした。

私の手持ちの電源は5vと12vは簡単に出せるのですが、3.3Vの電源基板やレギュレータ、安定化電源などを持っておらず、3VのACアダプタは紛失したので、このプロジェクトはまたしばらく保留とすることにしました。そのうちまたチャレンジしたいと思います。

このままでは少々悔しいので、作った（つくり途中）の全体を載せておきます。

![傘センサのお姿](images/chap-hiyoko/IMG_3535_no-exif.jpg?scale=0.5)

## 参考文献

CL(2015)『ESP-WROOM-02で玄関お出かけ天気カラー照明灯 - M.C.P.C. (Mamesibori Creation Plus Communication)』https://cl.hatenablog.com/entry/esp-wroom-02-weather-light (2021年11月19日閲覧)

SWITCH SCIENCE(2017)『i-Weather（アイウェザー）～玄関先で天気を知らせてくれるIoT～ - スイッチサイエンス』https://www.switch-science.com/catalog/3270/ （2021年11月19日閲覧）

TOYODA Eizi（2021）『TOYODA Eizi on Twitter: "一番伸びてるのはこれかしら。仕様の継続性や運用状況のお知らせを気象庁はお約束していないという意味で、APIではないと申し上げざるを得ないのですが、一方で政府標準利用規約に準拠してご利用いただけます。" / Twitter』https://twitter.com/e_toyoda/status/1364504338572410885 （2021年11月19日閲覧）

天気予報 API（livedoor 天気互換） (2020)『天気予報 API（livedoor 天気互換）』https://weather.tsukumijima.net/ （2021年11月19日閲覧） 

## 追伸

分圧回路って、その電圧になる仕組みは分かるけど、マイコンとかの動力源にしていいものなのでしょうか。あと、いい加減大きなブレッドボードが欲しくなってきたのでおそらく近いうちに買います。多分。

初期ファームでちゃんと動くかを確かめてからスケッチを書き込まないと問題発生時に何が悪いのかわからないと思い止めてしまいましたが、無視して続けていいのでしょうか?