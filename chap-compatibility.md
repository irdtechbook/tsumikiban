# 原因不明の不具合と「相性」

「相性」という言葉を聞いたことはありますか？性格の一致不一致とか、一緒にいて気が楽とか、人間間ではそういう表現・文脈でも使われますが、電子工作に限らず、工業製品一般に使われる用語です。ただし、何となくうまく動かないときなどに言い訳的に使われることもあります。そして、電子工作においては、何かミス、あるいはマージンを削っている状況んが原因にあることが少なくありません。ですが、原因究明に苦労することは多く、電子工作の醍醐味の一つではありますが、挫折原因の筆頭になることもあります。相性がある場合もありますが、相性と片付けず、頑張って追及しましょう。

本章では、この「相性」について触れます。ただし、相性問題をきちんと突き詰めることは非常に難易度が高い場合があります。原因がはっきりしないからこその「相性」でもあります。それでも、「そういうこともある」ということを知っているのと知らないのでは大違いです。

## 相性とはなにか？
パソコンなどの電子機器において、規格上は動作するのに、特定の組み合わせでは動作しない、不安定になる、といった状況を相性と呼びます。

まずは、パソコンにおける相性の例を取り上げ、簡単に解説しましょう。パソコンのボード、ドライバ、ソフトウエアはそれぞれ広く知られた規格や規定に合致するように作られています。50年以上前の初期の「パソコン」にはたくさんの独自規格があったため、基本そのメーカーの専用だったりしたこともありますが、PC/AT互換機と呼ばれるような1990年前後より新しいパソコンでは、規格の統一が進んできて、（建前上は）深く考えずとも接続、使用できるようになりました。それでも、「相性の悪い」組み合わせというものはありました。「PCIバス用」のボードなのに、PCIバスに挿しても動かない、PCが途中でハングアップする、などの症状が出ることがあり、「相性がキツい」といった表現をされることがありました。原因が「相性」である不具合が発生するとき、そのデバイス・パーツ単体は正常です。パーツが故障している、不良品であるというわけではありません。ところが、正常なパーツA（例えばマザーボード）と正常なパーツB（例えばグラフィックボード）を組み合わせて使うと、不具合が出るのです。また、マザーボードとグラボのように直接接続する場合のみではなくボード同士の相性もあり、例えばグラボ単体、キャプチャボード単体では動くのに、特定のグラボとキャプチャボードを2枚同時に挿すと不具合が出る、といったこともあります。

相性が発生する原因はいくつかあり、基本的には、製造メーカーの間で規格の解釈が食い違っていたり、検証不足だったり、またマージンが少なかったりすることが挙げられます。動作のタイミングがシビアであるとか、大容量のデータを流すなどの場合に相性が出やすくなります。また、ノイズ対策や電源周りが貧弱だとかいったことが原因のこともあります。高速・大量のデータを扱うグラフィックボードやビデオキャプチャボード、メモリなどは相性が出やすいパーツです。また、独自機能・独自設計を盛り込むことが多いデバイスも、相性が出やすいでしょう。メーカーの検証不足という点では、世の中のすべてのメーカーのすべてのパーツについて網羅的に検証することは不可能です。パーツの組み合わせだけでも組み合わせ爆発が生じるのに、さらに「使い方」まで含めると、検証は不可能です。

相性問題が生じた場合、原因追及は困難を極めることが少なくありません。原因が明確でないからこそ、試行錯誤的にトライする必要があります。単体パーツの動作検証は比較的簡単です。そして、その検証結果は「正常」です。そうなると、不具合の原因は不明となってしまいます。不具合の出る組み合わせがわかればまだHappyです。

PCパーツはたいていの場合比較的高価で、複数持っていることもあまりありません（逸般の誤家庭では予備パーツも含めてありますけど）。ですから、動作検証や不具合切り分け、クロスでのチェックなどはかなり大変です。先の例で挙げましたが、あるグラボとキャプチャボードを同時に使うと相性が出るとします。この時に、PC、グラボ、キャプチャボードが2セットあったらどうでしょう？それぞれクロスでチェックして、原因の切り分けができることがわかります。

![相性チェックの例](images/chap-compatibility/compatiPC.png)

ここで一つの思考実験です。PC-AとPC-Bがあり、グラボCとグラボD、キャプチャボードEとキャプチャボードFがあり、グラボCとキャプチャボードFを使ったときに相性による不具合が出るとしましょう。8通りすべてチェックできれば、それぞれの部品が正常で、かつ、グラボCと、ボードFの組み合わせにおいて不具合が生じる（＝相性がある）ということが確認できます。また、PC―Aだけで発生するのか、PC-Bでも発生するのか、といったように一般化していき、不具合が出る条件を探すことができます。

## 電子工作における不具合の調査・究明

電子工作において、うまく動作しないという現象が発生することがあります。むしろ、たいていの場合きちんと動きません。明確な原因がない（わからない）けれど、動かなかったり、動作が不安定だったりする現象が生じたとき、その原因追及を頑張るのですが、電子工作においても、その解決は大変困難です。

調査が難しい原因をいくつか取り上げましょう。

### 現象が目に見えない

作ったものが正常に動いているのか、そうでないのか、どこに不具合があるのかを知ることが解決への最初の一歩です。ところが、複数の要素があるなかで、そのどこに不具合の原因があるのかを突き止めるのは非常に難しい場合があります。むしろ、どこに不具合があるのかが分かった時点で、問題は半分以上解決しているといえるでしょう。

電子工作において、現象がみえることは稀です。電気は目に見えません。信号も目に見えません。通信も。ある種、入出力しかわからない、いえ、入力すらよくわからない何層もあるブラックボックスを、出力だけから推定する必要があるのです。

そこで測定器を使うのです。出力しかわからないところを、入力もわかるようになる、処理の途中の状態がわかるようになる、電源や接続状況が確認できるなど、ブラックボックスの中を少しづつみえるようにしていきましょう。

### 測定器がない
現象を可視化するためのツールが測定器です。目に見えない電圧を目に見えるようにするため、テスタやオシロスコープがあります。単純な電圧ならテスタ、波形含めて見るにはオシロスコープなどがあると問題解決の大きな手助けになるでしょう。

逆にいうと、測定器なしに問題解決するのは非常に大変です。暗闇の中手探りで、あるいは手探りですらなく、暗闇の迷路を、壁にぶつかるか通り抜けるかの2択チャレンジを延々と繰り返すようなものかもしれません。測定器があると便利ですよ、という記述が本書には何度か出てきますが、みえないものをみえるようにする点で、測定器は暗闇を照らす松明足りえます。最初から一気にすべてをそろえる必要はありませんが、機械があれば順次そろえていけるといいですね。

なお、前述の記述と矛盾するようですが、測定器があれば万事解決するかというと、そういうわけでもありません。

例えば、接触不良が疑われる状況があったとしましょう。テスタを持ってきて測定してみます。問題解決の第一歩ですね。テスタを用いる目的は、ケーブルがきちんと導通しているか、逆に導通してはいけないところがきちんと絶縁されているか、を確かめることです。確実に導通しているかは、人の目では見ることができません。その方針自体はきわめて正しいものです。

ところが、微妙な接触不良やショートは、テスタを当ててみても導通チェックでは音が鳴るかならないかでしかわかりませんし、テスタを当てることで微妙な接触不良が押し込まれ、テスト時だけ完全に導通しているということが生じえます。

はんだ不良（いわゆる芋はんだ）のように、見た目でもわからないし、直接触ってしまうと状況が変わるという事象はあります。

また、オシロをつなぐことでGNDの取り方が変わって挙動が変わるということもありえます。入力インピーダンスが高い回路などで不定になってしまうことなどあり、オシロを接続してないときは動作が不安定になり、オシロを接続することで、実質的にGNDが「たまたま」安定したため動作するようになる、外すと動かない、といった現象に直面するのです。適切にプルアップ/プルダウンしましょう、という回答になるのですが、これらも測定器があるから挙動が変わるという一例です。

こういった現象の対応として、テスタによる導通の例では、例えば両端で測定するといったことをやってみるとよいでしょう。

動作が不安定な回路があったとします。ICの出力と、それを受けるオペアンプがあり、その間をつなぐ配線があったとしましょう。そして、配線の右側に接触不良があったとします。

![接触不良の例](images/chap-compatibility/contact.png)

その導通を測定する時、オペアンプ側の接点で導通を見たらどうでしょう？接触不良部を押し込んで導通が取れてしまうと想定できます。

もちろん、逆側が接触不良の可能性もあります。

ですから、両方の接点をテスタで当たって、接触不良の有無を確認するなどの対応が必要になります。もちろん、毎回毎回2か所両方確認しなければならない、というわけではありません。ただ、「そういうこともあるかもしれない」という心づもりがあれば、チェック漏れ、あるいは原因の見逃しを防ぐことができます。

### 部品単体テストが難しい

### 試行錯誤のうちに壊す、焼ける

### 相性はある




